<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>e-Kiraana ‚Ä¢ Cart</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .qtyRow{display:flex;gap:8px;align-items:center;margin-top:10px}
    .qtyBtn{width:38px;height:38px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;font-weight:900;cursor:pointer}
    .qtyNum{min-width:28px;text-align:center;font-weight:900}
    .cartLine{border-bottom:1px dashed #e2e8f0;padding-bottom:14px;margin-bottom:14px}
    .summary{display:grid;gap:8px}
    .sumRow{display:flex;justify-content:space-between;font-weight:800}
    .sumRow .small{font-weight:700}
    .couponRow{display:flex;gap:10px;margin-top:10px}
  </style>
</head>
<body>

<div class="navbar">
  <div class="container inner">
    <div class="brand"><div class="logo">E</div> e-Kiraana</div>
    <div class="nav-actions">
      <a class="btn outline" href="categories.html">Shop More</a>
      <a class="btn outline" href="orders.html">Orders</a>
    </div>
  </div>
</div>

<div class="container">
  <div class="hero">
    <h1>My Cart üõí</h1>
    <p>Update quantities and checkout.</p>
  </div>

  <div class="grid cols-2">
    <!-- Cart Items -->
    <div class="card">
      <div class="title">Items</div>
      <div id="cartItems"></div>
      <div id="emptyBox" class="small" style="display:none;margin-top:10px">
        Your cart is empty. <a href="categories.html"><b>Start shopping ‚Üí</b></a>
      </div>
    </div>

    <!-- Summary -->
    <div class="card">
      <div class="title">Bill Summary</div>

      <div class="couponRow">
        <input class="input" id="coupon" placeholder="Coupon (TRY: SAVE10)" />
        <button class="btn outline" onclick="applyCoupon()">Apply</button>
      </div>

      <hr>

      <div class="summary">
        <div class="sumRow"><span class="small">Subtotal</span><span id="subTotal">‚Çπ0</span></div>
        <div class="sumRow"><span class="small">Delivery Fee</span><span id="deliveryFee">‚Çπ0</span></div>
        <div class="sumRow"><span class="small">Discount</span><span id="discount">-‚Çπ0</span></div>
        <hr>
        <div class="sumRow" style="font-size:18px">
          <span>Total</span>
          <span id="grandTotal">‚Çπ0</span>
        </div>
      </div>

      <br>
      <button class="btn" style="width:100%" onclick="goCheckout()">Proceed to Checkout</button>
      <button class="btn danger" style="width:100%;margin-top:10px" onclick="clearCart()">Clear Cart</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Updated ‚úÖ</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwnE6rvhunQy8pbs5y_N7kjjSW5hf58ypxg24nmSO5LzMmxEOajlXc1uY6IMjGO0Uo/exec";

/* GET helper (not used here but kept for standard) */
function api(params){
  const url = API + "?" + new URLSearchParams(params).toString();
  return fetch(url).then(r=>r.json());
}

function showToast(text, type="green"){
  const t=document.getElementById("toast");
  t.textContent=text;
  if(type==="red") t.style.background="#ef4444";
  else if(type==="yellow") t.style.background="#f59e0b";
  else t.style.background="#16a34a";
  t.style.display="block";
  setTimeout(()=>t.style.display="none",2000);
}

let COUPON_DISCOUNT = 0;

function getCart(){
  return JSON.parse(localStorage.getItem("cart") || "[]");
}
function setCart(cart){
  localStorage.setItem("cart", JSON.stringify(cart));
}

function calcSubtotal(cart){
  return cart.reduce((sum,i)=> sum + (Number(i.price||0) * Number(i.qty||1)), 0);
}

function deliveryFee(subtotal){
  // ‚úÖ professional fee rules
  if(subtotal === 0) return 0;
  if(subtotal >= 499) return 0;
  return 25;
}

function renderCart(){
  const cart = getCart();
  const box = document.getElementById("cartItems");
  const empty = document.getElementById("emptyBox");
  box.innerHTML="";

  if(cart.length === 0){
    empty.style.display="block";
    updateSummary();
    return;
  }
  empty.style.display="none";

  cart.forEach((p, idx)=>{
    box.innerHTML += `
      <div class="cartLine">
        <div class="row space">
          <b>${p.productName}</b>
          <button class="btn danger" style="padding:8px 12px" onclick="removeItem(${idx})">Remove</button>
        </div>
        <div class="small">${p.brand || "e-Kiraana"} ‚Ä¢ ${p.unit || ""}</div>
        <div class="row space" style="margin-top:10px">
          <div class="price">‚Çπ${p.price}</div>
          <div class="qtyRow">
            <button class="qtyBtn" onclick="qtyMinus(${idx})">-</button>
            <div class="qtyNum">${p.qty || 1}</div>
            <button class="qtyBtn" onclick="qtyPlus(${idx})">+</button>
          </div>
        </div>
      </div>
    `;
  });

  updateSummary();
}

function qtyPlus(i){
  const cart = getCart();
  cart[i].qty = (cart[i].qty || 1) + 1;
  setCart(cart);
  renderCart();
  showToast("Quantity updated ‚úÖ");
}

function qtyMinus(i){
  const cart = getCart();
  cart[i].qty = (cart[i].qty || 1) - 1;
  if(cart[i].qty <= 0) cart.splice(i,1);
  setCart(cart);
  renderCart();
  showToast("Quantity updated ‚úÖ");
}

function removeItem(i){
  const cart = getCart();
  cart.splice(i,1);
  setCart(cart);
  renderCart();
  showToast("Removed ‚ùå","yellow");
}

function clearCart(){
  if(!confirm("Clear cart?")) return;
  localStorage.removeItem("cart");
  COUPON_DISCOUNT = 0;
  renderCart();
  showToast("Cart cleared ‚úÖ");
}

function applyCoupon(){
  const code = document.getElementById("coupon").value.trim().toUpperCase();
  const cart = getCart();
  const subtotal = calcSubtotal(cart);

  COUPON_DISCOUNT = 0;

  if(code === "SAVE10" && subtotal >= 199){
    COUPON_DISCOUNT = Math.round(subtotal * 0.10);
    showToast("Coupon applied ‚úÖ");
  } else if(code){
    showToast("Invalid coupon ‚ùå","red");
  } else {
    showToast("Enter coupon code","yellow");
  }
  updateSummary();
}

function updateSummary(){
  const cart = getCart();
  const subtotal = calcSubtotal(cart);
  const fee = deliveryFee(subtotal);
  const discount = COUPON_DISCOUNT;
  const total = Math.max(0, subtotal + fee - discount);

  document.getElementById("subTotal").textContent = "‚Çπ" + subtotal;
  document.getElementById("deliveryFee").textContent = "‚Çπ" + fee;
  document.getElementById("discount").textContent = "-‚Çπ" + discount;
  document.getElementById("grandTotal").textContent = "‚Çπ" + total;

  localStorage.setItem("checkout_total", String(total));
}

function goCheckout(){
  const cart = getCart();
  if(cart.length === 0){
    showToast("Cart is empty ‚ö†Ô∏è","yellow");
    return;
  }
  location.href="checkout.html";
}

renderCart();
</script>

<div class="footer-space"></div>
</body>
</html>
